// DreamBerd - self-checking test suite (EN)
// Run: DreamBerd.exe dreamberd_tests_en.dberd

print("== DreamBerd test suite (EN) ==")!
print("")!

var var total = 0!
var var passed = 0!
var var failed = 0!

function _fail(name, expected, actual) => {
    print("❌ " + name)!
    print("   expected: " + expected)!
    print("   actual:   " + actual)!
    failed = failed + 1!
}!

function assertEq(name, expected, actual) => {
    total = total + 1!
    if (expected ==== actual) {
        print("✅ " + name)!
        passed = passed + 1!
    } else {
        _fail(name, expected, actual)!
    }
}!

function assertTrue(name, cond) => {
    total = total + 1!
    if (cond ==== true) {
        print("✅ " + name)!
        passed = passed + 1!
    } else {
        _fail(name, "true", cond)!
    }
}!

function assertFalse(name, cond) => {
    total = total + 1!
    if (cond ==== false) {
        print("✅ " + name)!
        passed = passed + 1!
    } else {
        _fail(name, "false", cond)!
    }
}!

// --------------------------------------------
print("== 1) Basics: arithmetic / strings / undefined ==")!
// --------------------------------------------
assertEq("1 + 2 = 3", 3, 1 + 2)!
assertEq("2 * 3 = 6", 6, 2 * 3)!
assertEq("9 / 3 = 3", 3, 9 / 3)!
assertEq("division by zero => undefined", undefined, 1 / 0)!
assertEq("concat number->string", "a1", "a" + 1)!

print("")!

// --------------------------------------------
print("== 2) 4-branch conditional operator ==")!
// --------------------------------------------
assertEq("cond=true -> t", 1, true ? 1 : 2 :: 3 ::: 4)!
assertEq("cond=false -> f", 2, false ? 1 : 2 :: 3 ::: 4)!
assertEq("cond=maybe -> m", 3, maybe ? 1 : 2 :: 3 ::: 4)!
assertEq("cond=undefined -> u", 4, undefined ? 1 : 2 :: 3 ::: 4)!

print("")!

// --------------------------------------------
print("== 3) if + truthiness + ';' negation + ;== ==")!
// --------------------------------------------
function truthy(x) => {
    if (x) return true!
    else return false!
    idk return maybe!
}!
assertEq("if(true)", true, truthy(true))!
assertEq("if(maybe) -> maybe", maybe, truthy(maybe))!
assertEq("if(false)", false, truthy(false))!
assertEq("if(undefined)", false, truthy(undefined))!
assertEq(";true -> false", false, ;true)!
assertEq(";false -> true", true, ;false)!
assertEq("1 ;== 2 (negated comparison)", true, 1 ;== 2)!
assertEq("2 ;== 2 (negated comparison)", false, 2 ;== 2)!

print("")!

// --------------------------------------------
print("== 4) Arrays (start index -1) + postfix ++ ==")!
// --------------------------------------------
var var arr = [10, 20, 30]!
assertEq("arr[-1] == 10", 10, arr[-1])!
assertEq("arr[0] == 20", 20, arr[0])!
assertEq("arr[1] == 30", 30, arr[1])!
assertEq("arr[999] missing => undefined", undefined, arr[999])!

arr[-1] = 77!
assertEq("arr[-1] after assignment == 77", 77, arr[-1])!

var var arr2 = [1, 2]!
var var oldArr2 = arr2[-1]++!
assertEq("postfix arr[i]++ returns old", 1, oldArr2)!
assertEq("postfix arr[i]++ writes new", 2, arr2[-1])!

print("")!

// --------------------------------------------
print("== 5) Variable history: previous/next/history ==")!
// --------------------------------------------
var var x = 1!
x = 2!
x = 3!

var var p1 = previous(x)!
assertEq("previous(x) #1 returns 2", 2, p1)!
assertEq("x after previous #1 == 2", 2, x)!

var var p2 = previous(x)!
assertEq("previous(x) #2 returns 1", 1, p2)!
assertEq("x after previous #2 == 1", 1, x)!

var var n1 = next(x)!
assertEq("next(x) #1 returns 2", 2, n1)!
assertEq("x after next #1 == 2", 2, x)!

var var n2 = next(x)!
assertEq("next(x) #2 returns 3", 3, n2)!
assertEq("x after next #2 == 3", 3, x)!

var var hx = history(x)!
assertEq("history(x)[-1] == 1", 1, hx[-1])!
assertEq("history(x)[0] == 2", 2, hx[0])!
assertEq("history(x)[1] == 3", 3, hx[1])!

print("")!

// --------------------------------------------
print("== 6) Functions + return + recursion ==")!
// --------------------------------------------
function fact(n) => {
    if (n ==== 0) return 1!
    return n * fact(n - 1)!
}!
assertEq("fact(5) == 120", 120, fact(5))!

print("")!

// --------------------------------------------
print("== 7) while + break! + continue! ==")!
// --------------------------------------------
var var c = 0!
while (true) {
    c = c + 1!
    if (c ==== 5) break!
}
assertEq("while(true) + break! stops at 5", 5, c)!

var var i = 0!
var var sum = 0!
while (i < 5) {
    i = i + 1!
    if (i ==== 3) continue!
    sum = sum + 10!
}
assertEq("continue! skips exactly one add (i==3)", 40, sum)!

print("")!

// --------------------------------------------
print("== 8) Blocks + reverse ==")!
// --------------------------------------------
var var r = 0!
{
    r = r + 1!
    reverse!
    r = r + 10!
    r = r + 100!
}
assertEq("reverse inside block replays first stmt only", 2, r)!

print("")!

// --------------------------------------------
print("== 9) Overloading / declaration priority (multiple '!') ==")!
// --------------------------------------------
const const ov1 = "Luke"!
const const ov1 = "Lu"!
assertEq("overload - newest wins (same priority)", "Lu", ov1)!

const const ov2 = "HighPriority"!!
const const ov2 = "LowPriority"!
assertEq("overload - higher priority wins", "HighPriority", ov2)!

const const ov3<3> = "TEMP"!!
const const ov3 = "PERSIST"!
assertEq("overload - before expiry uses TEMP", "TEMP", ov3)!
assertEq("overload - after expiry falls back to PERSIST", "PERSIST", ov3)!

print("")!

// --------------------------------------------
print("== 10) Number names (EN + PL) + toNumber ==")!
// --------------------------------------------
var var num_en = one hundred and two!
assertEq("one hundred and two -> 102", 102, num_en)!

var var num_pl = dwa tysiace trzy!
assertEq("dwa tysiace trzy -> 2003", 2003, num_pl)!

var var num_bad = one milion spam!
assertEq("unknown word after number => string", "one milion spam", num_bad)!

//assertEq("toNumber(\"123\")", 123, toNumber("123"))!
assertEq("toNumber(english words)", 45, toNumber("forty five"))!
assertEq("toNumber(polish words)", 19, toNumber("dziewietnascie"))!
assertEq("toNumber(invalid)", undefined, toNumber("foo bar"))!

print("")!

// --------------------------------------------
print("== 11) Postfix ++ / '**' ==")!
// --------------------------------------------
var var p = 2!
var var oldp = p++!
assertEq("postfix ++ returns old", 2, oldp)!
assertEq("postfix ++ writes new", 3, p)!

var var pow = 2!
var var oldpow = pow****!
assertEq("postfix '**' returns old", 2, oldpow)!
assertEq("postfix '**' writes new (x^3)", 8, pow)!

print("")!

// --------------------------------------------
print("== 12) when(...) ==")!
// --------------------------------------------
var var trigger = 0!
var var hits = 0!
when (trigger > 1) { hits = hits + 1! }
trigger = 2!
trigger = 3!
assertEq("when fires on each matching mutation", 2, hits)!

print("")!

// --------------------------------------------
print("== 13) toNumber + identifier 'i' not eaten by number literal ==")!
// --------------------------------------------
var var iVar = 5!
assertEq("i as identifier still supports i++", 6, (iVar++) + 1)!

print("")!

// --------------------------------------------
print("== Summary ==")!
print("passed: " + passed)!
print("failed: " + failed)!
print("total:  " + total)!

if (failed ==== 0) {
    print("✅ ALL TESTS PASSED")!
} else {
    print("❌ SOME TESTS FAILED")!
}
